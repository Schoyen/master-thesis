\chapter{Computing the one-body density matrices}
    From Kvaal\cite{kvaal2012ab} we have an expression for the one-body density
    matrices $\rho^q_p$\footnote{Note the ordering of the indices. We use the
    same convention as Kvaal in his article.} as a function of the coupled
    cluster amplitudes $t$ and $\lambda$.
    \begin{align}
        \rho^{q}_{p}
        &= \bra{\tilde{\Psi}}\ccr{p}\can{q}\ket{\Psi}
        = \bra{\tilde{\Phi}}(1 + \Lambda)e^{-T}\ccr{p}\can{q}e^T\ket{\Phi}.
    \end{align}
    We wish to find an expression for $\rho^{q}_{p}$ in terms of the amplitudes
    $t$ and $\lambda$ which we can contract. We start by splitting up the
    expression to
    \begin{align}
        \rho^q_p
        &= \bra{\tilde{\Phi}}e^{-T}\ccr{p}\can{q}e^T\ket{\Phi}
        + \bra{\tilde{\Phi}}\Lambda e^{-T}\ccr{p}\can{q}e^T\ket{\Phi}.
    \end{align}
    Next we expand the exponentials and use the Baker-Campbell-Hausdorff
    formula. This lets us write
    \begin{align}
        e^{-T}\ccr{p}\can{q}e^T
        &= \ccr{p}\can{q}
        + \com{\ccr{p}\can{q}}{T}
        + \frac{1}{2!}\com{\com{\ccr{p}\can{q}}{T}}{T}
        + \dots.
    \end{align}
    To determine how many terms to include we have to look at the number of
    excitations that will be performed by the excitation operators $T$ and
    relaxation operators $\Lambda$. We know that $T$ will \textit{at least}
    excite the reference by $1$. The combined operator $\ccr{p}\can{q}$ is able
    to excite and relax the reference with at most 1 or leave it unchanged. The
    relaxation operator $\Lambda$ will \textit{at least} relax the reference by
    $1$. As $\braket{\tilde{\Phi}_X}{\Phi_Y} = \delta_{XY}$, where $X$ and $Y$
    are arbitrary excitations, the only non-zero contributions to $\rho^q_p$
    will be the operator combinations that leave the reference unchanged after
    applying the total operator chain. For the term without $\Lambda$ in
    $\rho^q_p$ this leaves us with
    \begin{align}
        \bra{\tilde{\Phi}}e^{-T}\ccr{p}\can{q}e^T\ket{\Phi}
        &= \bra{\tilde{\Phi}}\ccr{p}\can{q}\ket{\Phi}
        + \bra{\tilde{\Phi}}\com{\ccr{p}\can{q}}{T}\ket{\Phi},
    \end{align}
    where the last term of the commutator will not contribute as leaving a $T$
    on the left hand side of $\ccr{p}\can{q}$ will leave the reference excited.
    \begin{align}
        \bra{\tilde{\Phi}}\Lambda e^{-T}\ccr{p}\can{q}e^T\ket{\Phi}
        &= \bra{\tilde{\Phi}}\Lambda \ccr{p}\can{q}\ket{\Phi}
        + \bra{\tilde{\Phi}}\Lambda \com{\ccr{p}\can{q}}{T}\ket{\Phi}
        \nonumber \\
        &\qquad
        + \frac{1}{2!}
        \bra{\tilde{\Phi}}\Lambda \com{\com{\ccr{p}\can{q}}{T}}{T}\ket{\Phi}
        + \dots.
        \label{eq:rho_q_p_lambda_part}
    \end{align}
    Depending on the truncation level of the coupled cluster equations, e.g.,
    singles, doubles etc, this will provide a natural truncation for
    \autoref{eq:rho_q_p_lambda_part}.

    \section{One-body density matrices for CCSD}
        Truncating at CCSD \autoref{eq:rho_q_p_lambda_part} will truncate at the
        double commutator as written. Employing SymPy\cite{sympy} we can compute
        an expression for the one-body density matrices.
        \begin{align}
            \rho^{q}_{p}
            &= \bra{\tilde{\Phi}}\ccr{p}\can{q}\ket{\Phi}
            + \bra{\tilde{\Phi}}\com{\ccr{p}\can{q}}{T}\ket{\Phi}
            + \bra{\tilde{\Phi}}\Lambda \ccr{p}\can{q}\ket{\Phi}
            \nonumber \\
            &\qquad
            + \bra{\tilde{\Phi}}\Lambda \com{\ccr{p}\can{q}}{T}\ket{\Phi}
            + \frac{1}{2!}
            \bra{\tilde{\Phi}}\Lambda \com{\com{\ccr{p}\can{q}}{T}}{T}\ket{\Phi}
            \\
            &=
            \delta^a_p \delta^q_b \para{
                l^i_a t^b_i + \frac{1}{2} l^{ij}_{ac} t^{bc}_{ij}
            }
            + \delta^a_p \delta^q_i l^i_a
            + \delta^q_j \delta^i_p \para{
                \delta^j_i
                - l^j_a t^a_i
                + \half l^{jk}_{ab} t^{ab}_{ki}
            }
            \nonumber \\
            &\qquad
            + \delta^q_a \delta^i_p \para{
                t^a_i
                + l^j_b \brak{
                    t^{ab}_{ij} - t^b_i t^a_j
                }
                + \half t^{b}_{i} l^{kj}_{cb} t^{ac}_{kj}
                - \half t^{a}_{j} l^{kj}_{cb} t^{cb}_{ki}
            }.
            \label{eq:rho_q_p_ccsd}
        \end{align}
        In this expression we have only kept the fully contracted terms. SymPy
        sets the indices arbitrarily so the expression shown in
        \autoref{eq:rho_q_p_ccsd} has been factorized and had a relabeling of
        the indices for improved readability.
